---
title: "PAC6"
author: "Maria Lucas Gascón"
date: "2024-01-17"
output: word_document
---

# Problema 1

Cargamos los datos del problema.

```{r}
# Seteamos el directorio de trabajo
setwd("D:/Antiguos estudios/MASTER2/Sem3/Diseño/PAC6/PAC6")

# Importamos los datos
data <- read.csv("dades_problema1_pec6.csv", dec = ",", header = TRUE, sep = ";")

# Marcamos los factores
data$espectrometro <- as.factor(data$espectrometro)
data$suelo <- as.factor(data$suelo)
data$dia <- factor(data$dia, levels = c(1, 2, 3), labels = c("dia1", "dia2", "dia3"))
```

## 1.1 Análisis descriptivo de los datos

```{r}
# Primero examinamos la variable ratio
summary(data$ratio)

# Box plot de ratio por espectrometro
boxplot(ratio ~ espectrometro, data = data, col = c("blue4", "aquamarine2", "cadetblue1"), main = "Boxplot de Ratio por Espectrómetro")

# Box plot de ratio por suelo
boxplot(ratio ~ suelo, data = data, col = c("darkslateblue", "darkviolet"), main = "Boxplot de Ratio por Suelo")

# Box plot de ratio por dia
boxplot(ratio ~ dia, data = data, col = c("darkgreen", "chartreuse3", "darkolivegreen2"), main = "Boxplot de Ratio por Dia")
```

## 1.2 Modelo lineal

En este problema, se busca modelar la proporción de 14N a 15N en dos tipos de suelos (urbano, rural) utilizando tres espectrómetros distintos. Se realizaron mediciones en 18 muestras de cada tipo de suelo. Cada muestra se asignó a uno de los tres espectrómetros al azar, y para cada combinación de suelo y espectrómetro, se eligieron 3 días al azar para realizar las mediciones. El objetivo es analizar la influencia de los factores suelo, espectrómetro y día, así como sus interacciones.

El modelo lineal puede expresarse de la siguiente manera:

$Y_{ijk} = \mu + \alpha_{i} + \beta_{j} + (\alpha\beta)_{ij} + C_{k(ij)} + \epsilon_{ijk}$

+ $Y_{ijk}$ es la medida de la proporción de 14N a 15N para la k-ésima observación en el suelo i, espectrómetro j y día k.
+ $\mu$ es la media global.
+ $\alpha_{i}$ es el efecto del i-ésimo nivel del factor suelo. La suma de todos los efectos del factor suelo debe ser cero: $\sum_{i = 1}^{2} \alpha_{i}=0$
+ $\beta_{j}$ es el efecto del j-ésimo nivel del factor espectrómetro. La suma de todos los efectos del factor espectrómetro debe ser cero: $\sum_{j = 1}^{3} \beta_{i}=0$
+ $(\alpha\beta)_{ij}$ es la interacción entre el suelo i y el espectrómetro j. La suma de las interacciones debe ser cero: $\sum\alpha\beta_{ij}=0$
+ $C_{k(ij)}$ es el efecto del k-ésimo nivel del factor día anidado en la combinación suelo i y espectrómetro j. Como es un efecto aleatorio, no hay restricciones específicas, pero se asume que sigue una distribución normal con media cero: $C_{k(ij)} \sim N(0, \sigma^2_{C})$
+ $\epsilon_{ijk}$ es el error aleatorio asociado con la k-ésima observación en la combinación suelo i, espectrómetro j y día k. Se asume que sigue una distribución normal con media cero: $\epsilon_{ijk} \sim N(0, \sigma^2_{\epsilon})$

## 1.3 Hipótesis de interés

Para el factor suelo:

+ $H_{0} : \alpha_{1} = \alpha_{2} = 0$. No hay diferencia significativa en la proporción de 14N a 15N entre los suelos urbanos y rurales.
+ $H_{1}:$ Almenos un $\alpha_{i} \ne 0$. Hay al menos una diferencia significativa en la proporción de 14N a 15N entre los suelos urbanos y rurales.

Para el factor espectrómetro:

+ $H_{0}: \beta_{1} = \beta_{2} = \beta_{3} = 0$. No hay diferencia significativa en la proporción de 14N a 15N entre los espectrómetros.
+ $H_{1}:$ Almenos un $\beta_{j} \ne 0$. Hay al menos una diferencia significativa en la proporción de 14N a 15N entre los tres espectrómetros distintos.

Para la interacción suelo-espectrómetro:

+ $H_{0}: (\alpha\beta)_{ij} = 0$ para todos los $i, j$. No hay interacción significativa entre el tipo de suelo y el espectrómetro.
+ $H_{1}:$ Existe al menos una $(\alpha\beta)_{ij} \ne 0$. Hay al menos una interacción significativa entre el tipo de suelo y el espectrómetro.

Para el efecto aleatorio del día:
+ $H_{0}: \sigma^2_{C(AB)} = 0$. No hay variabilidad significativa asociada con los días anidados en la combinación de suelo y espectrómetro.
+ $H_{1}: \sigma^2_{C(AB)} > 0$. Existe variabilidad significativa asociada con los días anidados en la combinación de suelo y espectrómetro.

Para el error aleatorio:
+ $H_{0}: \sigma^2_{\epsilon} = 0$. No hay variabilidad significativa no explicada por los factores considerados en el modelo.
+ $H_{1}: \sigma^2_{\epsilon} > 0$. Existe variabilidad significativa no explicada por los factores considerados en el modelo.

## 1.4 Estudiar las hipótesis

```{r}
# Definimos el modelo
library(lme4)
library(car)

modelo <- lmer(ratio ~ suelo + espectrometro + suelo:espectrometro + (1 | dia:suelo:espectrometro), data = data)

summary(modelo)

# Testamos las hipótesis

anova_modelo <- Anova(modelo, type = "III", test = "Chisq")
print(anova_modelo)
```

Especificar que queremos la ANOVA de "tipo III" implica que se atribuye la variabilidad a cada término después de tener en cuenta todos los demás términos, incluidas las interacciones que involucran ese término. Es útil cuando se tienen interacciones y se busca evaluar la contribución de cada variable a la variabilidad explicada, considerando las otras variables y sus interacciones.

Además, como no se han comprobado las suposiciones (normalidad y homocedasticidad), es preferible usar la prueba Chi-cuadrado en lugar de F.

Como podemos ver en los resultados, el suelo y la interacción suelo:espectrofotometro son significativas (pv<0.05), aunque el espectrofotómetro por sí mismo no lo es (pv>0.05). Veamos en detalle lo que esto significa:

+ Suelo Significativo: Hay diferencias estadísticamente significativas en la proporción de 14N a 15N entre los suelos urbanos y rurales (pv<0.05, se rechaza H0), después de tener en cuenta los otros efectos en el modelo. En otras palabras, hay evidencia estadística para afirmar que el tipo de suelo tiene un impacto significativo en la proporción de nitrógeno.

+ Espectrómetro No Significativo: No hay evidencia estadística suficiente para afirmar que hay diferencias en la proporción de 14N a 15N entre los distintos espectrómetros (pv>0.05, se acepta H0), después de considerar los otros efectos. En resumen, las variaciones observadas en la proporción de nitrógeno no pueden atribuirse de manera significativa a las diferencias entre los espectrómetros utilizados.

+ Interacción Suelo-Espectrómetro Significativa: La influencia del espectrómetro en la proporción de nitródeno depende del tipo de suelo. En otras palabras, la diferencia en la proporción de 14N a 15N entre los espectrómetros puede variar según si el suelo es urbano o rural. (pv<0.05, se rechaza H0). Esta interacción indica que el efecto del espectrómetro no es constante en todos los suelos y viceversa.

En resumen, los resultados sugieren que el tipo de suelo y la interacción entre el tipo de suelo y el espectrómetro son factores significativos en la variabilidad de la proporción de 14N a 15N, mientras que el espectrómetro por sí mismo no tiene un efecto significativo en esta proporción.

## 1.5 Comparaciones múltiples

Cómo el factor espectrómetro no mostraba diferencias significativas y el factor suelo sólo tiene 2 niveles; la única comparación múltiple que tiene sentido realizar es la de la interación.

```{r}
# install.packages("emmeans")
library(emmeans)
library(knitr)

# Realizamos las comparaciones múltiples
emmeans_result <- emmeans(modelo, pairwise ~ suelo:espectrometro)

# Ajustamos p-valores usando la corrección de Bonferroni
adjusted_emmeans <- summary(emmeans_result, infer = c(TRUE, TRUE), adjust = "bonferroni")

# Imprimimos los valores ajustados
print(adjusted_emmeans)
```

Como podemos ver, las siguientes combinaciones resultan significativas:

```{r}
# Extraemos los contrastes y p-valores
contrast_df <- as.data.frame(adjusted_emmeans$contrasts)

# Filtramos por p-valores < 0.05
significant_contrasts <- contrast_df[contrast_df$p.value < 0.05, c("contrast", "p.value")]


# Formateamos la tabla para imprimir
formatted_table <- data.frame(
  Contrast = significant_contrasts$contrast,
  P_Value = sprintf("%.4f", significant_contrasts$p.value)
)

# Imprimimos la tabla
kable(formatted_table, col.names = c("Contraste", "P-Valor"))
```

Eso significa que:

+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo rural es diferente cuando se utiliza el espectrómetro_1 en comparación con el suelo urbano cuando se utiliza el espectrómetro_2.
+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo rural es diferente cuando se utiliza el espectrómetro_2 en comparación con el suelo urbano cuando también se utiliza el espectrómetro_2.
+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo urbano es diferente cuando se utiliza el espectrómetro_2 en comparación con el suelo rural cuando se utiliza el espectrómetro_3.
+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo urbano es diferente cuando se utiliza el espectrómetro_2 en comparación con el mismo suelo urbano cuando se utiliza el espectrómetro_3.

Estos p-valores bajos indican que, después de ajustar para múltiples comparaciones, las diferencias observadas en estas combinaciones específicas son estadísticamente significativas. Para el resto de combinaciones no se observan diferencias significativas.

Cabe destacar la importancia de realizar una corrección para minimizar el error de tipo 1, ya que se estan realizando un gran número de comparaciones. En este caso se ha usado la corrección de Bonferroni.


# Problema 2

Cargamos los datos del problema.

```{r}
# Seteamos el directorio de trabajo
setwd("D:/Antiguos estudios/MASTER2/Sem3/Diseño/PAC6/PAC6")

# Importamos los datos
data <- read.csv("dades_problema2_pec6.csv", dec = ",", header = TRUE, sep = ";")

# Marcamos los factores
data$dieta <- as.factor(data$dieta)
```

## 2.1 Análisis descriptivo de los datos

```{r}
# Realiza un resumen descriptivo
summary(data)

# Gráfico relación consumo-incremento
color_dieta = c("tomato1", "olivedrab3", "turquoise", "slateblue2")

library(ggplot2)

# Gráfico de dispersión Incremento vs Consumo con dieta
ggplot(data, aes(x = consumo, y = incremento, color = factor(dieta))) +
  scale_color_manual(values = color_dieta) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Añade la línea de tendencia + 
  labs(title = "Relación entre Incremento y Consumo por Dieta",
       x = "Consumo",
       y = "Incremento") +
  theme_minimal()

# Gráfico de dispersión Incremento vs Consumo sin dieta
ggplot(data, aes(x = consumo, y = incremento)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Añade la línea de tendencia general
  labs(title = "Relación entre Incremento y Consumo",
       x = "Consumo",
       y = "Incremento") +
  theme_minimal()
```

```{r}
boxplot(incremento ~ dieta, data = data, col = color_dieta)
```

## 2.2 Modelo Lineal

### Ajustando ajustar el consumo calórico

El modelo lineal, teniendo en cuenta el consumo calórico, puede especificarse como:

$ y_{ij} = \mu + \alpha_{i} + \beta X_{ij} + \epsilon_{ij}$

Donde:

+ $y_{ij}$ es el aumento de peso del animal $j$ bajo la dieta $i$.
+ $\mu$ es el intercepto común para todas las dietas.
+ $\alpha_{i}$ es el intercepto específico para la dieta $i$.
+ $\beta$ es la pendiente de regresión, que representa el efecto del consumo calórico en el aumento de peso.
+ $Xij$ es el consumo calórico del animal $j$ bajo la dieta $i$.
+ $\epsilon_{ij}$ son errores experimentales aleatorios con distribución normal, media 0 y varianza $\sigma^2$. ($\epsilon_{ij} \sim N(0, \sigma^2)$).

Suposiciones adicionales:

+ $\sum_{i}^{a} \alpha_{i}=0$
+ El coeficiente de regresión $\beta$ es el mismo para todos los grupos de tratamiento (dietas).
+ Las dietas no influyen sobre el consumo calórico (covariante $X$)

Además se asumen otras dos suposiciones clave para este modelo, y es que el coeficiente de regresión $\beta$ es el mismo para todos los grupos (para todas las dietas) y que las dietas no influyen en la covariante $X$.

El modelo covariante para el tratamiento $i$ es una recta de regresión con pendiente $β$ que relaciona la variable respuesta con la covariante, que crea rectas paralelas con términos independientes (ordenadas al origen o intercepts en inglés) $\mu + \alpha_{i}$. Esto es un conjunto de rectas de regresión paralelas, una para cada tratamiento, con ordenadas al origen posiblemente diferentes.

### Sin ajustar por consumo calórico

El modelo lineal, sin tener en cuenta el consumo calórico, puede especificarse como:

$ y_{ij} = \mu + \alpha_{i} + \epsilon_{ij}$

Donde:

+ $y_{ij}$ es el aumento de peso del animal $j$ bajo la dieta $i$.
+ $\mu$ es el efecto medio global.
+ $\alpha_{i}$ es el efecto adicional de la dieta $i$ en comparación con el promedio global.
+ $\epsilon_{ij}$ son errores experimentales aleatorios con distribución normal, media 0 y varianza $\sigma^2$. ($\epsilon_{ij} \sim N(0, \sigma^2)$).

## 2.3 Efecto de la dieta

# Ajustando el consumo

```{r}
# Ajustar el modelo lineal
modelo_con <- lm(incremento ~ dieta + consumo, data = data)

summary(modelo_con)

# ANOVA - con la covariable primero y luego el factor
anova(lm(incremento ~ consumo + dieta, data=data))
```

### Sin ajustar el consumo

```{r}
# Ajustar el modelo lineal
modelo_sin <- lm(incremento ~ dieta, data = data)

# Resumen del modelo
summary(modelo_sin)

anova(modelo_sin)
```

## 2.4 Diagnosis de suposiciones

+ LAS YA MENCIONADAS

#### Linealidad: 

    Linealidad: Se asume que la relación entre la variable de respuesta (yy) y la covariable (XX) es lineal. Esto implica que los cambios en yy son proporcionales a los cambios en XX.

    Independencia de errores: Los errores (ϵijϵij​) deben ser independientes entre las observaciones. En el contexto de tu experimento, esto significa que el aumento de peso de un animal bajo una dieta específica no debe estar relacionado con el aumento de peso de otro animal bajo la misma dieta.

#### Homocedasticidad

    Homocedasticidad: La varianza de los errores debe ser constante en todos los niveles de la covariable. Esto significa que la dispersión de los errores debe ser constante a lo largo de todos los niveles de consumo calórico.

    Normalidad de errores: Aunque no es necesario para realizar inferencias sobre los coeficientes, la normalidad de los errores facilita la interpretación de los intervalos de confianza y las pruebas de hipótesis. Esto implica que los errores (ϵijϵij​) deben seguir una distribución normal.

    No colinealidad perfecta: Las covariables (en este caso, el consumo calórico XX) no deben tener una relación lineal perfecta entre sí (colinealidad perfecta). La colinealidad puede dificultar la interpretación de los coeficientes.

## 2.5 Diferencias entre dietas

Para determinar entre qué dietas hay diferencias significativas, se deben realizar pruebas de comparaciones múltiples.

```{r}
# Instalar y cargar el paquete multcomp
# install.packages("multcomp")
library(multcomp)

# Realizar comparaciones múltiples con el método de Tukey
comp <- glht(modelo_con, linfct = mcp(dieta = "Tukey"))

# Resumen de las comparaciones con ajuste de pvalores
resumen_comp <- summary(comp)
pvalores_ajustados <- p.adjust(resumen_comp$test$pvalues, method = "bonferroni")
resumen_comp$test$pvalues_ajustados <- pvalores_ajustados

# Mostrar el resumen con pvalores ajustados
print(resumen_comp)

```

Después de ajustar los pvalores por Bonferroni, vemos que existen diferencias significativas entre las dietas 4 y 1, las dietas 3 y 2 y por último las dietas 4 y 3.
Vemos que existen diferencias 