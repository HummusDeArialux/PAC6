---
title: "PAC6"
author: "Maria Lucas Gascón"
date: "2024-01-17"
output: word_document
---

# Problema 1

Cargamos los datos del problema.

```{r}
# Seteamos el directorio de trabajo
setwd("D:/Antiguos estudios/MASTER2/Sem3/Diseño/PAC6/PAC6")

# Importamos los datos
data <- read.csv("dades_problema1_pec6.csv", dec = ",", header = TRUE, sep = ";")

# Marcamos los factores
data$espectrometro <- as.factor(data$espectrometro)
data$suelo <- as.factor(data$suelo)
data$dia <- factor(data$dia, levels = c(1, 2, 3), labels = c("dia1", "dia2", "dia3"))
```

## 1.1 Análisis descriptivo de los datos

```{r}
# Primero examinamos la variable ratio
summary(data$ratio)

# Box plot de ratio por espectrometro
boxplot(ratio ~ espectrometro, data = data, col = c("blue4", "aquamarine2", "cadetblue1"), main = "Boxplot de Ratio por Espectrómetro")

# Box plot de ratio por suelo
boxplot(ratio ~ suelo, data = data, col = c("darkslateblue", "darkviolet"), main = "Boxplot de Ratio por Suelo")

# Box plot de ratio por dia
boxplot(ratio ~ dia, data = data, col = c("darkgreen", "chartreuse3", "darkolivegreen2"), main = "Boxplot de Ratio por Dia")
```

## 1.2 Modelo lineal

En este problema, se busca modelar la proporción de 14N a 15N en dos tipos de suelos (urbano, rural) utilizando tres espectrómetros distintos. Se realizaron mediciones en 18 muestras de cada tipo de suelo. Cada muestra se asignó a uno de los tres espectrómetros al azar, y para cada combinación de suelo y espectrómetro, se eligieron 3 días al azar para realizar las mediciones. El objetivo es analizar la influencia de los factores suelo, espectrómetro y día, así como sus interacciones.

El modelo lineal puede expresarse de la siguiente manera:

$Y_{ijk} = \mu + \alpha_{i} + \beta_{j} + (\alpha\beta)_{ij} + C_{k(ij)} + \epsilon_{ijk}$

+ $Y_{ijk}$ es la medida de la proporción de 14N a 15N para la k-ésima observación en el suelo i, espectrómetro j y día k.
+ $\mu$ es la media global.
+ $\alpha_{i}$ es el efecto del i-ésimo nivel del factor suelo. La suma de todos los efectos del factor suelo debe ser cero: $\sum_{i = 1}^{2} \alpha_{i}=0$
+ $\beta_{j}$ es el efecto del j-ésimo nivel del factor espectrómetro. La suma de todos los efectos del factor espectrómetro debe ser cero: $\sum_{j = 1}^{3} \beta_{i}=0$
+ $(\alpha\beta)_{ij}$ es la interacción entre el suelo i y el espectrómetro j. La suma de las interacciones debe ser cero: $\sum\alpha\beta_{ij}=0$
+ $C_{k(ij)}$ es el efecto del k-ésimo nivel del factor día anidado en la combinación suelo i y espectrómetro j. Como es un efecto aleatorio, no hay restricciones específicas, pero se asume que sigue una distribución normal con media cero: $C_{k(ij)} \sim N(0, \sigma^2_{C})$
+ $\epsilon_{ijk}$ es el error aleatorio asociado con la k-ésima observación en la combinación suelo i, espectrómetro j y día k. Se asume que sigue una distribución normal con media cero: $\epsilon_{ijk} \sim N(0, \sigma^2_{\epsilon})$

## 1.3 Hipótesis de interés

Para el factor suelo:

+ $H_{0} : \alpha_{1} = \alpha_{2} = 0$. No hay diferencia significativa en la proporción de 14N a 15N entre los suelos urbanos y rurales.
+ $H_{1}:$ Almenos un $\alpha_{i} \ne 0$. Hay al menos una diferencia significativa en la proporción de 14N a 15N entre los suelos urbanos y rurales.

Para el factor espectrómetro:

+ $H_{0}: \beta_{1} = \beta_{2} = \beta_{3} = 0$. No hay diferencia significativa en la proporción de 14N a 15N entre los espectrómetros.
+ $H_{1}:$ Almenos un $\beta_{j} \ne 0$. Hay al menos una diferencia significativa en la proporción de 14N a 15N entre los tres espectrómetros distintos.

Para la interacción suelo-espectrómetro:

+ $H_{0}: (\alpha\beta)_{ij} = 0$ para todos los $i, j$. No hay interacción significativa entre el tipo de suelo y el espectrómetro.
+ $H_{1}:$ Existe al menos una $(\alpha\beta)_{ij} \ne 0$. Hay al menos una interacción significativa entre el tipo de suelo y el espectrómetro.

Para el efecto aleatorio del día:
+ $H_{0}: \sigma^2_{C(AB)} = 0$. No hay variabilidad significativa asociada con los días anidados en la combinación de suelo y espectrómetro.
+ $H_{1}: \sigma^2_{C(AB)} > 0$. Existe variabilidad significativa asociada con los días anidados en la combinación de suelo y espectrómetro.

Para el error aleatorio:
+ $H_{0}: \sigma^2_{\epsilon} = 0$. No hay variabilidad significativa no explicada por los factores considerados en el modelo.
+ $H_{1}: \sigma^2_{\epsilon} > 0$. Existe variabilidad significativa no explicada por los factores considerados en el modelo.

## 1.4 Estudiar las hipótesis

```{r}
# Definimos el modelo
library(lme4)
library(car)

modelo <- lmer(ratio ~ suelo + espectrometro + suelo:espectrometro + (1 | dia:suelo:espectrometro), data = data)

summary(modelo)

# Testamos las hipótesis

anova_modelo <- Anova(modelo, type = "III", test = "Chisq")
print(anova_modelo)
```

Especificar que queremos la ANOVA de "tipo III" implica que se atribuye la variabilidad a cada término después de tener en cuenta todos los demás términos, incluidas las interacciones que involucran ese término. Es útil cuando se tienen interacciones y se busca evaluar la contribución de cada variable a la variabilidad explicada, considerando las otras variables y sus interacciones.

Además, como no se han comprobado las suposiciones (normalidad y homocedasticidad), es preferible usar la prueba Chi-cuadrado en lugar de F.

Como podemos ver en los resultados, el suelo y la interacción suelo:espectrofotometro son significativas (pv<0.05), aunque el espectrofotómetro por sí mismo no lo es (pv>0.05). Veamos en detalle lo que esto significa:

+ Suelo Significativo: Hay diferencias estadísticamente significativas en la proporción de 14N a 15N entre los suelos urbanos y rurales (pv<0.05, se rechaza H0), después de tener en cuenta los otros efectos en el modelo. En otras palabras, hay evidencia estadística para afirmar que el tipo de suelo tiene un impacto significativo en la proporción de nitrógeno.

+ Espectrómetro No Significativo: No hay evidencia estadística suficiente para afirmar que hay diferencias en la proporción de 14N a 15N entre los distintos espectrómetros (pv>0.05, se acepta H0), después de considerar los otros efectos. En resumen, las variaciones observadas en la proporción de nitrógeno no pueden atribuirse de manera significativa a las diferencias entre los espectrómetros utilizados.

+ Interacción Suelo-Espectrómetro Significativa: La influencia del espectrómetro en la proporción de nitródeno depende del tipo de suelo. En otras palabras, la diferencia en la proporción de 14N a 15N entre los espectrómetros puede variar según si el suelo es urbano o rural. (pv<0.05, se rechaza H0). Esta interacción indica que el efecto del espectrómetro no es constante en todos los suelos y viceversa.

En resumen, los resultados sugieren que el tipo de suelo y la interacción entre el tipo de suelo y el espectrómetro son factores significativos en la variabilidad de la proporción de 14N a 15N, mientras que el espectrómetro por sí mismo no tiene un efecto significativo en esta proporción.

## 1.5 Comparaciones múltiples

Cómo el factor espectrómetro no mostraba diferencias significativas y el factor suelo sólo tiene 2 niveles; la única comparación múltiple que tiene sentido realizar es la de la interación.

```{r}
# install.packages("emmeans")
library(emmeans)
library(knitr)

# Realizamos las comparaciones múltiples
emmeans_result <- emmeans(modelo, pairwise ~ suelo:espectrometro)

# Ajustamos p-valores usando la corrección de Bonferroni
adjusted_emmeans <- summary(emmeans_result, infer = c(TRUE, TRUE), adjust = "bonferroni")

# Imprimimos los valores ajustados
print(adjusted_emmeans)
```

Como podemos ver, las siguientes combinaciones resultan significativas:

```{r}
# Extraemos los contrastes y p-valores
contrast_df <- as.data.frame(adjusted_emmeans$contrasts)

# Filtramos por p-valores < 0.05
significant_contrasts <- contrast_df[contrast_df$p.value < 0.05, c("contrast", "p.value")]


# Formateamos la tabla para imprimir
formatted_table <- data.frame(
  Contrast = significant_contrasts$contrast,
  P_Value = sprintf("%.4f", significant_contrasts$p.value)
)

# Imprimimos la tabla
kable(formatted_table, col.names = c("Contraste", "P-Valor"))
```

Eso significa que:

+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo rural es diferente cuando se utiliza el espectrómetro_1 en comparación con el suelo urbano cuando se utiliza el espectrómetro_2.
+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo rural es diferente cuando se utiliza el espectrómetro_2 en comparación con el suelo urbano cuando también se utiliza el espectrómetro_2.
+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo urbano es diferente cuando se utiliza el espectrómetro_2 en comparación con el suelo rural cuando se utiliza el espectrómetro_3.
+ Hay evidencia significativa para afirmar que la proporción de nitrógeno en el suelo urbano es diferente cuando se utiliza el espectrómetro_2 en comparación con el mismo suelo urbano cuando se utiliza el espectrómetro_3.

Estos p-valores bajos indican que, después de ajustar para múltiples comparaciones, las diferencias observadas en estas combinaciones específicas son estadísticamente significativas. Para el resto de combinaciones no se observan diferencias significativas.

Cabe destacar la importancia de realizar una corrección para minimizar el error de tipo 1, ya que se estan realizando un gran número de comparaciones. En este caso se ha usado la corrección de Bonferroni.


# Problema 2

Cargamos los datos del problema.

```{r}
# Seteamos el directorio de trabajo
setwd("D:/Antiguos estudios/MASTER2/Sem3/Diseño/PAC6/PAC6")

# Importamos los datos
data <- read.csv("dades_problema2_pec6.csv", dec = ",", header = TRUE, sep = ";")

# Marcamos los factores
data$dieta <- as.factor(data$dieta)
```

## 2.1 Análisis descriptivo de los datos

```{r}
# Realiza un resumen descriptivo
summary(data)

# Gráfico relación consumo-incremento
color_dieta = c("tomato1", "olivedrab3", "turquoise", "slateblue2")

# Boxplot incremento por dieta
boxplot(incremento ~ dieta, data = data, col = color_dieta)

# Boxplot consumo por dieta
boxplot(consumo ~ dieta, data = data, col = color_dieta)

library(ggplot2)

# Gráfico de dispersión Incremento vs Consumo sin dieta
ggplot(data, aes(x = consumo, y = incremento)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Añade la línea de tendencia general
  labs(title = "Relación entre Incremento y Consumo",
       x = "Consumo",
       y = "Incremento") +
  theme_minimal()

# Gráfico de dispersión Incremento vs Consumo por dieta
ggplot(data, aes(x = consumo, y = incremento, color = factor(dieta))) +
  scale_color_manual(values = color_dieta) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Añade la línea de tendencia + 
  labs(title = "Relación entre Incremento y Consumo por Dieta",
       x = "Consumo",
       y = "Incremento") +
  theme_minimal()
```

Se evidencia una distribución equilibrada con 5 animales por cada tipo de dieta, lo que configura un diseño balanceado.

El análisis del primer boxplot, que representa la relación entre el incremento de peso y la dieta, sugiere variaciones significativas entre los grupos. Esto se infiere al observar diferencias en las alturas de las cajas y la línea central, que representa la media de cada grupo. Además, las distintas alturas y longitudes de las líneas de dispersión indican variabilidades divergentes entre los grupos.

En contraste, al examinar el segundo boxplot que relaciona el consumo de calorías con la dieta, se puede inferir si existen disparidades en el consumo calórico entre los grupos. Efectivamente, se observan diferencias notables entre los grupos.

Por otro lado, el gráfico que ilustra la relación entre el aumento de peso y el consumo calórico revela una correlación positiva general. A mayor consumo de calorías, se evidencia un mayor incremento de peso, y viceversa.

Al analizar esta relación de manera específica para cada dieta, se mantiene la correlación positiva, pero se aprecian pendientes distintas para cada tipo de dieta. Destaca que la dieta 4 exhibe la correlación positiva más pronunciada.

En conjunto, estos hallazgos contribuyen a una comprensión más profunda de las relaciones entre las variables, lo que facilita el ajuste preciso de los modelos de regresión.

## 2.2 Modelo Lineal

### Ajustando según el consumo calórico

El modelo lineal, teniendo en cuenta el consumo calórico, puede especificarse como:

$y_{ij} = \mu + \alpha_{i} + \beta X_{ij} + \epsilon_{ij}$

Donde:

+ $y_{ij}$ es el aumento de peso del animal $j$ bajo la dieta $i$.
+ $\mu$ es el intercepto común para todas las dietas.
+ $\alpha_{i}$ es el intercepto específico para la dieta $i$.
+ $\beta$ es la pendiente de regresión, que representa el efecto del consumo calórico en el aumento de peso.
+ $Xij$ es el consumo calórico del animal $j$ bajo la dieta $i$.
+ $\epsilon_{ij}$ son errores experimentales aleatorios con distribución normal, media 0 y varianza $\sigma^2$. ($\epsilon_{ij} \sim N(0, \sigma^2)$).

Suposiciones adicionales:

+ $\sum_{i}^{a} \alpha_{i}=0$
+ El coeficiente de regresión $\beta$ es el mismo para todos los grupos de tratamiento (dietas).
+ Las dietas no influyen sobre el consumo calórico (covariante $X$)

El modelo covariante propone utilizar una línea de regresión para cada tratamiento. Esta línea representa cómo la variable de interés cambia en relación con la covariable. Todas las líneas son similares en términos de la dirección de cambio, es decir, comparten la misma "pendiente" ($β$). Esto significa que todos los tratamientos responden de manera similar a la covariable.

Sin embargo, hay diferencias entre los tratamientos, y estas diferencias se reflejan en los términos independientes o "ordenadas al origen" ($\mu + \alpha_{i}$). Cada tratamiento tiene su propia ordenada al origen ($\alpha_{i}$), que se suma a una ordenada al origen común ($\mu$). Esto significa que aunque las líneas son paralelas, pueden tener alturas diferentes en el eje vertical, indicando que cada tratamiento puede tener un nivel inicial diferente en la variable de interés.

En resumen, el modelo utiliza líneas de regresión paralelas para representar cómo los diferentes tratamientos responden a la covariable, con la flexibilidad de tener diferentes niveles iniciales debido a los términos $\alpha_{i}$.

### Sin ajustar por consumo calórico

El modelo lineal, sin tener en cuenta el consumo calórico, puede especificarse como:

$y_{ij} = \mu + \alpha_{i} + \epsilon_{ij}$

Donde:

+ $y_{ij}$ es el aumento de peso del animal $j$ bajo la dieta $i$.
+ $\mu$ es el efecto medio global.
+ $\alpha_{i}$ es el efecto adicional de la dieta $i$ en comparación con el promedio global.
+ $\epsilon_{ij}$ son errores experimentales aleatorios con distribución normal, media 0 y varianza $\sigma^2$. ($\epsilon_{ij} \sim N(0, \sigma^2)$).

En este caso, el modelo lineal es mucho más simple porque no se tiene en cuenta la covariable consumo. Es por ello que este modelo simple describe cómo las observaciones ($y_{ij}$) se componen del nivel medio común ($\mu$), la contribución única de cada tratamiento ($\alpha_{i}$), y la variabilidad no explicada ($\epsilon_{ij}$).

## 2.3 Efecto de la dieta

# Ajustando el consumo

```{r}
# Ajustar el modelo lineal
modelo_con <- lm(incremento ~ dieta + consumo, data = data)

summary(modelo_con)
```

En el caso de variables dummy que representan categorías (como las dietas), el término constante (o intercepto) es la estimación del valor medio de la variable de respuesta para la categoría de referencia. En este caso, la dieta 1 es la categoría de referencia. Entonces, el término constante representará la estimación del aumento de peso medio para la dieta 1. Las otras variables dummy (dieta 2, dieta 3 y dieta 4) indicarán cómo difieren las otras dietas en comparación con la dieta 1. En resumen, se puede considerar que la dieta 1 es equivalente al intercepto en este contexto específico.

Una vez explicado esto, podemos ver en el resumen del modelo que la estimación para la dieta 1 (intercepto) es de 15.74, y para la dieta 2 es de -14.94. Esto quiere decir que la dieta 1 hace que el peso incremente más que con la dieta 2. No debemos confundir que el estimado de la dieta 2 sea negativo con que disminuya el peso, si no que aumenta pero en menor medida que con la dieta 1, que es con la que se está comparando. Esto concuerda con la exploración inicial de los datos, en la que la dieta 1 mostraba mayor incremento de peso que la dieta 2.

### Sin ajustar el consumo

```{r}
# Ajustar el modelo lineal
modelo_sin <- lm(incremento ~ dieta, data = data)

# Resumen del modelo
summary(modelo_sin)
```

En este caso, el estimado para la dieta 1 es de 63, mientras que para la dieta 2 es de -15.8. Como mencionamos previamente, esto indica que la dieta 1 está asociada con un mayor aumento de peso en comparación con la dieta 2.

Al comparar el estimado de la dieta 1 ajustando el modelo con y sin la covariable, notamos una diferencia sustancial en la estimación (15.74 vs 63). Esta disparidad probablemente se debe a la omisión del efecto del consumo calórico en el modelo sin covariable.

Como hemos observado en la exploración de datos, existe una relación positiva entre la covariable (consumo) y la variable de respuesta. Al no incluir esta covariable en el modelo, parte de la variabilidad debida al consumo se atribuye erróneamente a la variable dieta. Esto se refleja en un estimado más alto para la dieta 1, que sirve como referencia.

Al incorporar el consumo como una covariable en el modelo, estamos intentando aislar el efecto específico de la dieta en el aumento de peso, controlando o ajustando por las diferencias en el consumo entre las dietas. Este enfoque proporciona una estimación más precisa del efecto de la dieta, eliminando el posible sesgo en la relación entre la covariable y la variable de respuesta.

En resumen, al incluir el consumo como covariable, se mejora la capacidad del modelo para discernir entre los efectos de la dieta y el consumo en el aumento de peso, lo que resulta en estimaciones más ajustadas y potencialmente más precisas.

En resumen, al incluir el consumo como covariable, se está mejorando la capacidad del modelo para discernir entre los efectos de la dieta y el consumo en el aumento de peso, y, por lo tanto, se obtienen estimaciones más ajustadas y potencialmente más precisas.

## 2.4 Diagnosis de suposiciones

#### Independencia de los residuos

```{r}
# Gráfico de residuos vs. orden de observaciones
plot(resid(modelo_con) ~ seq_along(resid(modelo_con)))

library(lmtest)
# Prueba de Durbin-Watson para autocorrelación de los residuos
dwtest(modelo_con)
```



#### Homocedasticidad

```{r}
plot(modelo_con, which=1)

# Prueba de Breusch-Pagan para homocedasticidad
library(lmtest)
bptest(modelo_con)
```

La dispersión de los residuos es constante a medida que cambian los valores ajustados. Vemos una dispersión uniforme de puntos alrededor de cero, indicando homocedasticidad.

Por otro lado, la prueba de Breusch-Pagan testa la H0 de homocedasticidad. Como obtenemos un pvalor alto (mayor que 0.05) sugiere que no hay suficiente evidencia para rechazar la hipótesis nula, indicando homocedasticidad.

#### Normalidad

```{r}
plot(modelo_con, which=2)

shapiro.test(modelo_con$residuals)
```

Tanto a partir del QQ-Plot (puntos alrededor de la diagonal), como el test de Shapiro-Wilks (p-valor > 0,05), concluimos que los residuos son normales.

## 2.5 Diferencias entre dietas

Para determinar entre qué dietas hay diferencias significativas, se deben realizar pruebas de comparaciones múltiples.

```{r}
# Instalar y cargar el paquete multcomp
# install.packages("multcomp")
library(multcomp)

# Realizar comparaciones múltiples con el método de Tukey
comp <- glht(modelo_con, linfct = mcp(dieta = "Tukey"))

# Resumen de las comparaciones con ajuste de pvalores
resumen_comp <- summary(comp)
pvalores_ajustados <- p.adjust(resumen_comp$test$pvalues, method = "bonferroni")
resumen_comp$test$pvalues_ajustados <- pvalores_ajustados

# Mostrar el resumen con pvalores ajustados
print(resumen_comp)
```
Se han realizado comparaciones múltiples por el método Tukey, y después de ajustar los pvalores por Bonferroni, vemos que existen diferencias significativas entre las dietas 4 y 1, las dietas 3 y 2 y por último las dietas 4 y 3.